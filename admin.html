<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Control - Gesti√≥n de Productos</title>
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      padding: 40px;
      width: 100%;
      max-width: 500px;
      margin: 20px;
    }

    .login-form {
      text-align: center;
    }

    .admin-panel {
      display: none;
    }

    h1 {
      color: #333;
      margin-bottom: 30px;
      font-size: 2em;
    }

    .form-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #555;
      font-weight: 600;
    }

    input[type="email"], input[type="password"] {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    input[type="email"]:focus, input[type="password"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 1em;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .credentials-info {
      text-align: center;
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 20px;
    }

    .warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
      padding: 10px;
      border-radius: 5px;
      margin-top: 15px;
      font-size: 0.8em;
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e1e5e9;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .tab.active {
      border-bottom-color: #667eea;
      color: #667eea;
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .form-row {
      display: flex;
      gap: 15px;
    }

    .form-row .form-group {
      flex: 1;
    }

    .product-list, .notification-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e1e5e9;
      border-radius: 8px;
      padding: 10px;
      margin-top: 15px;
    }

    .product-item, .notification-item {
      background: #f8f9fa;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.8em;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Formulario de Login -->
    <div id="login-form" class="login-form">
      <h1>üîê Acceso Administrativo</h1>
      <form onsubmit="adminLogin(); return false;">
        <div class="form-group">
          <label for="admin-email">Usuario Administrador</label>
          <input type="email" id="admin-email" value="ccipbcncrd4@grupocaher.com" required>
        </div>
        <div class="form-group">
          <label for="admin-password">Contrase√±a</label>
          <input type="password" id="admin-password" placeholder="Tu contrase√±a de Supabase" required>
        </div>
        <button type="submit" class="btn" style="
          width: 100%;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          padding: 12px 25px;
          border-radius: 8px;
          font-size: 1em;
          font-weight: 600;
          cursor: pointer;
          margin-bottom: 15px;
        ">üöÄ Acceder al Panel</button>
      </form>
      
      <div class="credentials-info">
        <p><strong>üîê Acceso Restringido</strong></p>
        <p>Usuario autorizado:</p>
        <p>Email: <code>ccipbcncrd4@grupocaher.com</code></p>
        <div class="warning">
          ‚ö†Ô∏è <strong>IMPORTANTE:</strong> Solo este usuario puede acceder al panel de administraci√≥n
        </div>
      </div>
    </div>

    <!-- Panel de Administraci√≥n -->
    <div id="admin-panel" class="admin-panel">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>üéõÔ∏è Panel de Control</h1>
        <button class="logout-btn" onclick="adminLogout()">üö™ Cerrar Sesi√≥n</button>
      </div>

      <div class="tabs">
        <div class="tab active" onclick="showTab('products')">üì¶ Productos</div>
        <div class="tab" onclick="showTab('notifications')">üîî Notificaciones</div>
        <div class="tab" onclick="showTab('settings')">‚öôÔ∏è Configuraci√≥n</div>
      </div>

      <!-- Tab de Productos -->
      <div id="products-tab" class="tab-content active">
        <h3>‚ûï A√±adir Producto</h3>
        <form id="product-form" onsubmit="addProduct(); return false;">
          <div class="form-row">
            <div class="form-group">
              <label for="product-name">Nombre del Producto</label>
              <input type="text" id="product-name" required>
            </div>
            <div class="form-group">
              <label for="product-section">Secci√≥n</label>
              <select id="product-section" required>
                <option value="">Seleccionar secci√≥n</option>
                <option value="FEM ALCAMPO">FEM ALCAMPO</option>
                <option value="Coca Cola">Coca Cola</option>
                <option value="Coca Cola Zero">Coca Cola Zero</option>
                <option value="coca cola light">Coca Cola Light</option>
                <option value="Coca Cola Zero Zero">Coca Cola Zero Zero</option>
                <option value="Coca Cola Sabores">Coca Cola Sabores</option>
                <option value="Fanta naranja">Fanta Naranja</option>
                <option value="Fanta lim√≥n">Fanta Lim√≥n</option>
                <option value="Fanta sabores">Fanta Sabores</option>
                <option value="Sprite">Sprite</option>
                <option value="T√≥nica">T√≥nica</option>
                <option value="Burn">Burn</option>
                <option value="Energ√©ticas">Energ√©ticas</option>
                <option value="M.Maid">M.Maid</option>
                <option value="FUZE">FUZE</option>
                <option value="Deportivas">Deportivas</option>
                <option value="Isot√≥nicas">Isot√≥nicas</option>
                <option value="Appletiser">Appletiser</option>
                <option value="Aquabona">Aquabona</option>
                <option value="Alcoholes">Alcoholes</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="product-price">Precio (‚Ç¨)</label>
              <input type="number" id="product-price" step="0.01" min="0" required>
            </div>
            <div class="form-group">
              <label for="product-previous-price">Precio Anterior (‚Ç¨)</label>
              <input type="number" id="product-previous-price" step="0.01" min="0">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>
                <input type="checkbox" id="product-is-new"> üÜï Producto Nuevo
              </label>
            </div>
            <div class="form-group">
              <label>
                <input type="checkbox" id="product-has-alert"> ‚ö†Ô∏è Alerta de Cantidad
              </label>
            </div>
          </div>
          <div class="form-group" id="min-quantity-group" style="display: none;">
            <label for="product-min-quantity">Cantidad M√≠nima</label>
            <input type="number" id="product-min-quantity" min="1" value="1">
          </div>
          <button type="submit" class="btn">‚ûï A√±adir Producto</button>
        </form>

        <h3>üìã Productos Actuales</h3>
        <div id="product-list" class="product-list">
          <p>Cargando productos...</p>
        </div>
      </div>

      <!-- Tab de Notificaciones -->
      <div id="notifications-tab" class="tab-content">
        <h3>üîî A√±adir Notificaci√≥n</h3>
        <form id="notification-form" onsubmit="addNotification(); return false;">
          <div class="form-group">
            <label for="notification-title">T√≠tulo</label>
            <input type="text" id="notification-title" required>
          </div>
          <div class="form-group">
            <label for="notification-message">Mensaje</label>
            <textarea id="notification-message" rows="3" required></textarea>
          </div>
          <div class="form-group">
            <label for="notification-type">Tipo</label>
            <select id="notification-type">
              <option value="info">‚ÑπÔ∏è Informaci√≥n</option>
              <option value="warning">‚ö†Ô∏è Advertencia</option>
              <option value="success">‚úÖ √âxito</option>
              <option value="error">‚ùå Error</option>
            </select>
          </div>
          <button type="submit" class="btn">üîî A√±adir Notificaci√≥n</button>
        </form>

        <h3>üìã Notificaciones Actuales</h3>
        <div id="notification-list" class="notification-list">
          <p>Cargando notificaciones...</p>
        </div>
      </div>

      <!-- Tab de Configuraci√≥n -->
      <div id="settings-tab" class="tab-content">
        <h3>üîê Seguridad</h3>
        <div class="form-group">
          <label for="new-email">Nuevo Email</label>
          <input type="email" id="new-email" placeholder="nuevo@email.com">
        </div>
        <div class="form-group">
          <label for="new-password">Nueva Contrase√±a</label>
          <input type="password" id="new-password" placeholder="Nueva contrase√±a">
        </div>
        <button class="btn" onclick="changeCredentials()">üîê Cambiar Credenciales</button>

        <h3>üë• Usuarios Autorizados</h3>
        <div class="form-group">
          <label for="authorized-email">Email a Autorizar</label>
          <input type="email" id="authorized-email" placeholder="usuario@ejemplo.com">
        </div>
        <button class="btn" onclick="addAuthorizedUser()">‚ûï Autorizar Usuario</button>
        
        <h4>Usuarios Actualmente Autorizados:</h4>
        <div id="authorized-users-list" class="product-list">
          <p>Cargando usuarios autorizados...</p>
        </div>

        <h3>üîÑ Sincronizaci√≥n</h3>
        <div class="form-group">
          <button class="btn" onclick="syncWithMainApp()">üîÑ Sincronizar con App Principal</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuraci√≥n de Supabase
    const SUPABASE_CONFIG = {
      url: 'https://fhotsfpgzuuiftfadskv.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZob3RzZnBnenV1aWZ0ZmFkc2t2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0NjQ4MjIsImV4cCI6MjA3NjA0MDgyMn0.84mj_bPceuIwO96Ugcykh3fyK3GuP2pQ1UywU3Inr0I'
    };

    // Variables globales
    let supabase = null;
    let currentUser = null;
    
    // Lista de usuarios autorizados (solo estos pueden acceder)
    const AUTHORIZED_USERS = [
      'ccipbcncrd4@grupocaher.com',  // Usuario autorizado
    ];

    // Inicializar Supabase
    function initSupabase() {
      try {
        supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        console.log('‚úÖ Cliente Supabase inicializado correctamente');
        return true;
      } catch (error) {
        console.error('‚ùå Error al inicializar Supabase:', error);
        return false;
      }
    }

    // Funci√≥n de login
    async function adminLogin() {
      const email = document.getElementById('admin-email').value;
      const password = document.getElementById('admin-password').value;
      
      if (!email || !password) {
        alert('Por favor, completa todos los campos');
        return;
      }

      // Inicializar Supabase si no est√° inicializado
      if (!supabase) {
        if (!initSupabase()) {
          alert('Error al inicializar Supabase');
          return;
        }
      }

      try {
        // Intentar autenticaci√≥n con Supabase
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          console.error('Error de autenticaci√≥n:', error);
          alert('Credenciales incorrectas: ' + error.message);
          return;
        }

        if (data.user) {
          // Verificar si el usuario est√° autorizado
          if (!AUTHORIZED_USERS.includes(data.user.email)) {
            alert('‚ùå Acceso denegado. Tu email no est√° autorizado para acceder al panel de administraci√≥n.');
            await supabase.auth.signOut();
            return;
          }
          
          currentUser = data.user;
          console.log('‚úÖ Login exitoso:', currentUser.email);
          showAdminPanel();
        }
      } catch (error) {
        console.error('Error en login:', error);
        alert('Error al iniciar sesi√≥n: ' + error.message);
      }
    }

    // Mostrar panel de administraci√≥n
    function showAdminPanel() {
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('admin-panel').style.display = 'block';
      loadProducts();
      loadNotifications();
      loadAuthorizedUsers();
    }

    // Cerrar sesi√≥n
    async function adminLogout() {
      if (supabase && currentUser) {
        await supabase.auth.signOut();
      }
      currentUser = null;
      document.getElementById('login-form').style.display = 'block';
      document.getElementById('admin-panel').style.display = 'none';
    }

    // Mostrar tab
    function showTab(tabName) {
      // Ocultar todos los tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Mostrar tab seleccionado
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    // A√±adir producto
    async function addProduct() {
      const name = document.getElementById('product-name').value;
      const section = document.getElementById('product-section').value;
      const price = parseFloat(document.getElementById('product-price').value);
      const previousPrice = parseFloat(document.getElementById('product-previous-price').value) || null;
      const isNew = document.getElementById('product-is-new').checked;
      const hasAlert = document.getElementById('product-has-alert').checked;
      const minQuantity = parseInt(document.getElementById('product-min-quantity').value) || 0;

      if (!supabase) {
        alert('Supabase no est√° inicializado');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('products')
          .insert([
            {
              name: name,
              section: section,
              price: price,
              previous_price: previousPrice,
              is_new: isNew,
              has_quantity_alert: hasAlert,
              min_quantity: minQuantity
            }
          ]);

        if (error) {
          console.error('Error al a√±adir producto:', error);
          alert('Error al a√±adir producto: ' + error.message);
          return;
        }

        alert('‚úÖ Producto a√±adido correctamente');
        document.getElementById('product-form').reset();
        loadProducts();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al a√±adir producto: ' + error.message);
      }
    }

    // Cargar productos
    async function loadProducts() {
      if (!supabase) return;

      try {
        const { data, error } = await supabase
          .from('products')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error al cargar productos:', error);
          return;
        }

        const productList = document.getElementById('product-list');
        if (data && data.length > 0) {
          productList.innerHTML = data.map(product => `
            <div class="product-item">
              <div>
                <strong>${product.name}</strong><br>
                <small>Secci√≥n: ${product.section} | Precio: ‚Ç¨${product.price}</small>
                ${product.is_new ? '<br><span style="color: #27ae60;">üÜï NUEVO</span>' : ''}
                ${product.has_quantity_alert ? `<br><span style="color: #e74c3c;">‚ö†Ô∏è M√çN: ${product.min_quantity}</span>` : ''}
              </div>
              <button class="delete-btn" onclick="deleteProduct(${product.id})">üóëÔ∏è</button>
            </div>
          `).join('');
        } else {
          productList.innerHTML = '<p>No hay productos a√±adidos</p>';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Eliminar producto
    async function deleteProduct(id) {
      if (!supabase) return;
      if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) return;

      try {
        const { error } = await supabase
          .from('products')
          .delete()
          .eq('id', id);

        if (error) {
          console.error('Error al eliminar producto:', error);
          alert('Error al eliminar producto: ' + error.message);
          return;
        }

        alert('‚úÖ Producto eliminado correctamente');
        loadProducts();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar producto: ' + error.message);
      }
    }

    // A√±adir notificaci√≥n
    async function addNotification() {
      const title = document.getElementById('notification-title').value;
      const message = document.getElementById('notification-message').value;
      const type = document.getElementById('notification-type').value;

      if (!supabase) {
        alert('Supabase no est√° inicializado');
        return;
      }

      try {
        const { data, error } = await supabase
          .from('notifications')
          .insert([
            {
              title: title,
              message: message,
              type: type
            }
          ]);

        if (error) {
          console.error('Error al a√±adir notificaci√≥n:', error);
          alert('Error al a√±adir notificaci√≥n: ' + error.message);
          return;
        }

        alert('‚úÖ Notificaci√≥n a√±adida correctamente');
        document.getElementById('notification-form').reset();
        loadNotifications();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al a√±adir notificaci√≥n: ' + error.message);
      }
    }

    // Cargar notificaciones
    async function loadNotifications() {
      if (!supabase) return;

      try {
        const { data, error } = await supabase
          .from('notifications')
          .select('*')
          .eq('is_active', true)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error al cargar notificaciones:', error);
          return;
        }

        const notificationList = document.getElementById('notification-list');
        if (data && data.length > 0) {
          notificationList.innerHTML = data.map(notification => `
            <div class="notification-item">
              <div>
                <strong>${notification.title}</strong><br>
                <small>${notification.message}</small><br>
                <span style="color: #666;">Tipo: ${notification.type}</span>
              </div>
              <button class="delete-btn" onclick="deleteNotification(${notification.id})">üóëÔ∏è</button>
            </div>
          `).join('');
        } else {
          notificationList.innerHTML = '<p>No hay notificaciones activas</p>';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Eliminar notificaci√≥n
    async function deleteNotification(id) {
      if (!supabase) return;
      if (!confirm('¬øEst√°s seguro de que quieres eliminar esta notificaci√≥n?')) return;

      try {
        const { error } = await supabase
          .from('notifications')
          .update({ is_active: false })
          .eq('id', id);

        if (error) {
          console.error('Error al eliminar notificaci√≥n:', error);
          alert('Error al eliminar notificaci√≥n: ' + error.message);
          return;
        }

        alert('‚úÖ Notificaci√≥n eliminada correctamente');
        loadNotifications();
      } catch (error) {
        console.error('Error:', error);
        alert('Error al eliminar notificaci√≥n: ' + error.message);
      }
    }

    // Cambiar credenciales
    async function changeCredentials() {
      const newEmail = document.getElementById('new-email').value;
      const newPassword = document.getElementById('new-password').value;

      if (!newEmail && !newPassword) {
        alert('Por favor, introduce al menos un campo para cambiar');
        return;
      }

      if (!supabase || !currentUser) {
        alert('No hay sesi√≥n activa');
        return;
      }

      try {
        const updates = {};
        if (newEmail) updates.email = newEmail;
        if (newPassword) updates.password = newPassword;

        const { error } = await supabase.auth.updateUser(updates);

        if (error) {
          console.error('Error al cambiar credenciales:', error);
          alert('Error al cambiar credenciales: ' + error.message);
          return;
        }

        alert('‚úÖ Credenciales actualizadas correctamente');
        document.getElementById('new-email').value = '';
        document.getElementById('new-password').value = '';
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar credenciales: ' + error.message);
      }
    }

    // Sincronizar con app principal
    function syncWithMainApp() {
      alert('üîÑ Sincronizaci√≥n completada. Los cambios se ver√°n reflejados en la aplicaci√≥n principal.');
    }

    // A√±adir usuario autorizado
    function addAuthorizedUser() {
      const email = document.getElementById('authorized-email').value;
      
      if (!email) {
        alert('Por favor, introduce un email');
        return;
      }

      if (AUTHORIZED_USERS.includes(email)) {
        alert('Este usuario ya est√° autorizado');
        return;
      }

      AUTHORIZED_USERS.push(email);
      document.getElementById('authorized-email').value = '';
      loadAuthorizedUsers();
      alert('‚úÖ Usuario autorizado correctamente');
    }

    // Cargar usuarios autorizados
    function loadAuthorizedUsers() {
      const userList = document.getElementById('authorized-users-list');
      if (AUTHORIZED_USERS.length > 0) {
        userList.innerHTML = AUTHORIZED_USERS.map((email, index) => `
          <div class="product-item">
            <div>
              <strong>${email}</strong>
              ${email === currentUser?.email ? '<br><span style="color: #27ae60;">üë§ Usuario actual</span>' : ''}
            </div>
            ${email !== currentUser?.email ? `<button class="delete-btn" onclick="removeAuthorizedUser(${index})">üóëÔ∏è</button>` : ''}
          </div>
        `).join('');
      } else {
        userList.innerHTML = '<p>No hay usuarios autorizados</p>';
      }
    }

    // Eliminar usuario autorizado
    function removeAuthorizedUser(index) {
      const email = AUTHORIZED_USERS[index];
      if (!confirm(`¬øEst√°s seguro de que quieres desautorizar a ${email}?`)) return;

      AUTHORIZED_USERS.splice(index, 1);
      loadAuthorizedUsers();
      alert('‚úÖ Usuario desautorizado correctamente');
    }

    // Mostrar/ocultar campo de cantidad m√≠nima
    document.getElementById('product-has-alert').addEventListener('change', function() {
      const minQuantityGroup = document.getElementById('min-quantity-group');
      if (this.checked) {
        minQuantityGroup.style.display = 'block';
      } else {
        minQuantityGroup.style.display = 'none';
      }
    });

    // Inicializar cuando se carga la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ Panel de administraci√≥n cargado');
    });
  </script>
</body>
</html>
