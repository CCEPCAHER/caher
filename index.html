<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PEDIDOS</title>
  <link rel="stylesheet" href="styles.css">
  <meta name="description" content="Compra en el mejor supermercado para telÃ©fonos mÃ³viles.">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
  <!-- Formulario de login -->
  <div id="login-container">
    <form id="login-form">
      <select id="store" required>
        <option value="" disabled selected>Selecciona tu supermercado</option>
      </select>
      <input type="text" id="username" placeholder="Usuario" required>
      <input type="password" id="password" placeholder="ContraseÃ±a" required>
      <button type="submit">Iniciar SesiÃ³n</button>
    </form>
  </div>
  
  <!-- Contenido protegido: se mostrarÃ¡ una vez que el usuario inicie sesiÃ³n -->
  <div id="contenido" style="display:none;">
    <header>
      <h1>PEDIDOS</h1>
    </header>
    <main>
      <!-- Contenedor de productos -->
      <section id="product-list">
        <!-- AquÃ­ podrÃ­as listar productos; para el ejemplo se agregarÃ¡ uno fijo -->
      </section>
      <!-- BotÃ³n para enviar pedido a Power Automate -->
      <button id="send-order-btn" onclick="enviarPedido()">Enviar Pedido a Power Automate</button>
    </main>
    
    <!-- Total siempre visible -->
    <div id="total-display" aria-live="polite">Total: â‚¬0.00</div>
    
    <!-- BotÃ³n flotante del carrito (movible) -->
    <button id="cart-toggle" aria-label="Ver carrito">ðŸ›’</button>
    
    <!-- Modal del carrito -->
    <div id="cart-modal" role="dialog" aria-modal="true" aria-labelledby="cart-modal-title">
      <div id="cart-modal-content">
        <button id="close-modal" aria-label="Cerrar carrito" onclick="toggleCart()">âœ–</button>
        <h2 id="cart-modal-title">Tu Pedido</h2>
        <div id="cart-items-modal">No hay productos aÃ±adidos.</div>
        <div id="modal-total">Total: â‚¬0.00</div>
        <button id="submit-order" onclick="submitOrder()">Enviar Pedido</button>
      </div>
    </div>
    
    <!-- Elemento de audio para notificar al agregar producto -->
    <audio id="add-sound" src="beep.mp3" preload="auto"></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
  </div>
  
  <!-- Script de autenticaciÃ³n, gestiÃ³n de contraseÃ±a y envÃ­o de pedido -->
  <script>
    // Array de usuarios vÃ¡lidos (para este ejemplo, se gestiona localmente)
    const USERS = [
      { username: "ccipbcncrd8@grupocaher.com", store: "Alcampo Sant Boi",     password: "1234" },
      { username: "ccipbcncrd4@grupocaher.com", store: "Alcampo Sant Quirze", password: "1234" },
      { username: "ccipbcncrd8@grupocaher.com", store: "Alcampo Esplugues",   password: "1234" },
      { username: "ccipbcncrd4@grupocaher.com",                   store: "Carrefour Sant Cugat",      password: "1234" },
      { username: "ccipbcncrd4@grupocaher.com",                   store: "Carrefour Barbera",      password: "1234" }
    ];

    // Al cargar la pÃ¡gina, si existen credenciales guardadas, prellenamos los campos.
    document.addEventListener("DOMContentLoaded", function() {
      // Rellenar el combo de supermercados con valores Ãºnicos de "store"
      const stores = [...new Set(USERS.map(user => user.store))];
      const storeSelect = document.getElementById('store');
      stores.forEach(store => {
        const option = document.createElement('option');
        option.value = store;
        option.textContent = store;
        storeSelect.appendChild(option);
      });

      // Cargar valores guardados
      const savedStore = localStorage.getItem("savedStore");
      const savedUsername = localStorage.getItem("savedUsername");
      const savedPassword = localStorage.getItem("savedPassword");

      if (savedStore && savedUsername && savedPassword) {
        document.getElementById("store").value = savedStore;
        document.getElementById("username").value = savedUsername;
        document.getElementById("password").value = savedPassword;
      }
    });

    // Evento para el formulario de login
    document.getElementById("login-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const storeInput = document.getElementById("store").value;
      const usernameInput = document.getElementById("username").value.trim();
      const passwordInput = document.getElementById("password").value.trim();
      
      // Buscar usuario que coincida con las credenciales
      const userFound = USERS.find(user => 
        user.store === storeInput &&
        user.username === usernameInput &&
        user.password === passwordInput
      );
      
      if (userFound) {
        // Guardar las credenciales en localStorage
        localStorage.setItem("savedStore", storeInput);
        localStorage.setItem("savedUsername", usernameInput);
        localStorage.setItem("savedPassword", passwordInput);
        // Guardar el nombre del centro (store) para enviarlo a Power Automate
        localStorage.setItem("userStore", userFound.store);
        localStorage.setItem("loggedInUser", userFound.username);

        // Mostrar el contenido
        mostrarContenido();
      } else {
        alert("Credenciales incorrectas o supermercado no vÃ¡lido");
      }
    });

    // FunciÃ³n para mostrar el contenido protegido tras el login
    function mostrarContenido() {
      document.getElementById("login-container").style.display = "none";
      document.getElementById("contenido").style.display = "block";
      // Mostrar el nombre del almacÃ©n en el header, si estÃ¡ almacenado
      const storeName = localStorage.getItem("userStore");
      if (storeName) {
        const header = document.querySelector("header h1");
        header.textContent += " - " + storeName;
      }
    }

    // FunciÃ³n para enviar el pedido a Power Automate usando el nombre del centro
    function enviarPedido() {
      // Recupera los datos desde localStorage
      const username = localStorage.getItem("savedUsername");
      const password = localStorage.getItem("savedPassword");
      const userStore = localStorage.getItem("userStore") || "";  // fallback si fuese null

      // Registra en consola lo que se ha recuperado
      console.log("Datos recuperados:", { username, password, userStore });

      // Ejemplo de productos seleccionados (ajusta segÃºn tu lÃ³gica)
      const products = [
        {
          product: "Producto A",
          quantity: 2,
          price: 10.5
        },
        {
          product: "Producto B",
          quantity: 1,
          price: 5.75
        }
      ];

      // Construimos el objeto 'pedido' que se enviarÃ¡
      const pedido = {
        username: username,
        password: password,
        userStore: userStore,
        products: products
      };

      // Muestra el objeto 'pedido' en la consola antes de enviarlo
      console.log("Objeto 'pedido' que se enviarÃ¡:", JSON.stringify(pedido));

      // EnvÃ­o a Power Automate mediante fetch (URL proporcionada)
      fetch("https://prod-241.westeurope.logic.azure.com:443/workflows/b86ee01c42c2495ca93cb2989e7ad4b3/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=QIyKPBTQZuH1uk0jhYoQ_fh-3DZWZpjR4hA80yPNxeg", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(pedido)
      })
      .then(response => response.json())
      .then(data => {
        console.log("Respuesta recibida del flujo:", data);
        alert("Pedido enviado correctamente.");
      })
      .catch(error => {
        console.error("Error al enviar el pedido:", error);
        alert("Error al enviar el pedido.");
      });
    }
  </script>
</body>
</html> 
